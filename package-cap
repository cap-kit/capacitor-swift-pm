#!/usr/bin/env bash -euo pipefail

# ------------------------------------------------------------
# Assumptions:
# - XCFrameworks are already present in ./ios
#   - ios/Capacitor.xcframework
#   - ios/Cordova.xcframework
# - This script ONLY packages and generates Package.swift
# ------------------------------------------------------------

VERSION="$1"

if [ -z "$VERSION" ]; then
  echo "ERROR: release version argument is required"
  exit 1
fi

rm -rf frameworks
mkdir -p frameworks

echo "Zipping XCFrameworks..."

zip -r frameworks/Capacitor.xcframework.zip ios/Capacitor.xcframework
zip -r frameworks/Cordova.xcframework.zip ios/Cordova.xcframework

# ------------------------------------------------------------
# Compute checksums
# ------------------------------------------------------------

cap_sha=$(shasum -a 256 frameworks/Capacitor.xcframework.zip | awk '{print $1}')
cord_sha=$(shasum -a 256 frameworks/Cordova.xcframework.zip | awk '{print $1}')

# ------------------------------------------------------------
# URLs (pointing to cap-kit fork releases)
# ------------------------------------------------------------

cap_url="https://github.com/cap-kit/capacitor-swift-pm/releases/download/${VERSION}/Capacitor.xcframework.zip"
cord_url="https://github.com/cap-kit/capacitor-swift-pm/releases/download/${VERSION}/Cordova.xcframework.zip"

# ------------------------------------------------------------
# Write Package.swift
# ------------------------------------------------------------

cat <<EOF > Package.swift
// swift-tools-version:5.3

import PackageDescription

let package = Package(
    name: "capacitor-swift-pm",
    products: [
        .library(
            name: "Capacitor",
            targets: ["Capacitor"]
        ),
        .library(
            name: "Cordova",
            targets: ["Cordova"]
        )
    ],
    dependencies: [],
    targets: [
        .binaryTarget(
            name: "Capacitor",
            url: "$cap_url",
            checksum: "$cap_sha"
        ),
        .binaryTarget(
            name: "Cordova",
            url: "$cord_url",
            checksum: "$cord_sha"
        )
    ]
)
EOF

echo "Package.swift generated successfully"
echo "Capacitor checksum: $cap_sha"
echo "Cordova checksum:   $cord_sha"
