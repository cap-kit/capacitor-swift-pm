name: Build and Release

on:
  workflow_call:
    inputs:
      release-version:
        required: true
        type: string
      draft-flag:
        type: string
        default: " "
    secrets:
      CAPACITOR_REPO_TOKEN:
        required: true

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
      # ------------------------------------------------------------
      # Toolchain selection (unchanged, harmless)
      # ------------------------------------------------------------
      - run: |
          if [[ "${{ inputs.release-version }}" =~ ^7\. ]]; then
            sudo xcode-select --switch /Applications/Xcode_16.2.app
          else
            sudo xcode-select --switch /Applications/Xcode_26.0.app
          fi

      # ------------------------------------------------------------
      # Checkout
      # ------------------------------------------------------------
      - uses: actions/checkout@v4

      # ------------------------------------------------------------
      # Install gh (needed to fetch artifacts)
      # ------------------------------------------------------------
      - name: Install dependencies
        run: brew install gh

      # ------------------------------------------------------------
      # Download prebuilt XCFrameworks from cap-kit/capacitor
      # ------------------------------------------------------------
      - name: Download iOS XCFrameworks from capacitor repo
        env:
          GH_TOKEN: ${{ secrets.CAPACITOR_REPO_TOKEN }}
        run: |
          set -euo pipefail

          mkdir -p ios

          echo "Fetching latest ios-xcframeworks artifact from cap-kit/capacitor"

          ARTIFACT_URL=$(gh api \
            repos/cap-kit/capacitor/actions/artifacts \
            --jq '.artifacts[] | select(.name=="ios-xcframeworks") | .archive_download_url' \
            | head -n 1)

          if [ -z "$ARTIFACT_URL" ]; then
            echo "ERROR: ios-xcframeworks artifact not found"
            exit 1
          fi

          curl -L -H "Authorization: token $GH_TOKEN" "$ARTIFACT_URL" -o ios/artifacts.zip
          unzip -o ios/artifacts.zip -d ios

          echo "Downloaded XCFrameworks:"
          ls -la ios

      # ------------------------------------------------------------
      # Skip local build (intentional)
      # ------------------------------------------------------------
      - name: Skip local build (using prebuilt XCFrameworks)
        run: echo "Skipping build-cap, using prebuilt XCFrameworks"

      # ------------------------------------------------------------
      # Package Capacitor and Cordova (unchanged script)
      # ------------------------------------------------------------
      - name: Package Capacitor and Cordova
        run: ./package-cap ${{ inputs.release-version }}

      # ------------------------------------------------------------
      # NOTE:
      # - No signing
      # - No commit
      # - No GitHub release
      # ------------------------------------------------------------
