name: Update SwiftPM binaries from Capacitor release

on:
  workflow_dispatch:
    inputs:
      capacitor_release_tag:
        description: 'Tag from cap-kit/capacitor (e.g. ios-8.0.2-spm-fix2)'
        required: true
        type: string
      spm_version:
        description: 'New SemVer tag for capacitor-swift-pm (e.g. 8.0.2-spmfix3)'
        required: true
        type: string

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5

      - name: Download checksums.json
        run: |
          curl -L \
            https://github.com/cap-kit/capacitor/releases/download/${{ inputs.capacitor_release_tag }}/checksums.json \
            -o checksums.json

      - name: Validate checksums
        run: |
          jq -e '.capacitor and .cordova' checksums.json > /dev/null

      - name: Update Package.swift
        env:
            RELEASE_TAG: ${{ inputs.capacitor_release_tag }}
        run: |
            python3 <<'EOF'
            from pathlib import Path
            import re
            import os
            import json

            tag = os.environ["RELEASE_TAG"]

            data = json.loads(Path("checksums.json").read_text())
            cap = data["capacitor"]
            cord = data["cordova"]

            if not cap or not cord:
                raise SystemExit("Invalid checksums.json contents")

            text = Path("Package.swift").read_text()

            def update_target(text, name, checksum):
                pattern = re.compile(
                    rf'(\.binaryTarget\(\s*name:\s*"{name}".*?checksum:\s*")[^"]+(")',
                    re.S
                )
                match = pattern.search(text)
                if not match:
                    raise SystemExit(f"Target {name} not found")
                return pattern.sub(lambda m: f'{m.group(1)}{checksum}{m.group(2)}', text)

            text = update_target(text, "Capacitor", cap)
            text = update_target(text, "Cordova", cord)

            text = re.sub(
                r'https://github.com/.*/Capacitor.xcframework.zip',
                f'https://github.com/cap-kit/capacitor/releases/download/{tag}/Capacitor.xcframework.zip',
                text
            )
            text = re.sub(
                r'https://github.com/.*/Cordova.xcframework.zip',
                f'https://github.com/cap-kit/capacitor/releases/download/{tag}/Cordova.xcframework.zip',
                text
            )

            Path("Package.swift").write_text(text)
            EOF

      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git commit -am "fix(spm): update binaries to ${{ inputs.capacitor_release_tag }}"

      - name: Tag and push
        run: |
          git tag ${{ inputs.spm_version }}
          git push origin HEAD
          git push origin ${{ inputs.spm_version }}
